{"id":"df-1be","title":"Implement fan-in LLM evaluation mode","description":"Spec 4.9: When a fan-in node has a prompt, it should use LLM-based evaluation to rank candidates rather than the heuristic.\n\n> If node.prompt is not empty:\n>     -- LLM-based evaluation: call LLM to rank candidates\n>     best = llm_evaluate(node.prompt, results)\n> Else:\n>     -- Heuristic: rank by outcome status, then by score\n>     best = heuristic_select(results)\n\nCurrently FanInHandler only implements the heuristic path. When a prompt is present, it should call the CodergenBackend to evaluate candidates.\n\n## Files\n- packages/attractor-core/src/handlers/handlers.ts -- FanInHandler: when node.prompt is set, call backend to evaluate\n- packages/attractor-core/src/handlers/registry.ts -- FanInHandler needs access to backend\n- packages/attractor-core/tests/parallel-subgraph.test.ts -- add test\n\n## Tests\n- fan-in with prompt -> backend called with prompt + serialized results\n- fan-in without prompt -> heuristic selection (existing behavior)","status":"open","priority":3,"issue_type":"feature","created_at":"2026-02-11T00:34:23.848692Z","created_by":"jhugman","updated_at":"2026-02-11T00:34:23.848692Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"df-1e0","title":"Epic 14: Parallel handler — missing join/error policies and bounded parallelism","description":"Implement the remaining parallel handler features per spec §4.8.\n\nCurrently only `wait_all` and `first_success` join policies are implemented. The spec also defines `k_of_n` and `quorum` join policies, `max_parallel` bounded parallelism, and `error_policy` (fail_fast, continue, ignore).\n\nSpec §4.8 join policies table:\n- `k_of_n` — \"At least K branches must succeed.\"\n- `quorum` — \"At least a configurable fraction of branches must succeed.\"\n\nSpec §4.8 error policies table:\n- `fail_fast` — \"Cancel all remaining branches on first failure.\"\n- `continue` — \"Continue remaining branches. Collect all results.\"\n- `ignore` — \"Ignore failures entirely. Return only successful results.\"\n\nSpec §4.8 pseudocode: `max_parallel = integer(node.attrs.get(\"max_parallel\", \"4\"))`","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-11T00:33:06.711592Z","created_by":"jhugman","updated_at":"2026-02-11T01:25:30.886168Z","closed_at":"2026-02-11T01:25:30.886123Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"df-1e0.1","title":"Implement k_of_n and quorum join policies","description":"Spec §4.8 join policies:\n- `k_of_n` — \"At least K branches must succeed.\" Read K from `node.attrs.get(\"join_k\")`.\n- `quorum` — \"At least a configurable fraction of branches must succeed.\" Read fraction from `node.attrs.get(\"join_quorum\")`.\n\n## Files\n- `packages/attractor-core/src/handlers/handlers.ts` — ParallelHandler, add k_of_n and quorum evaluation after result collection\n- `packages/attractor-core/tests/parallel-subgraph.test.ts` — add tests\n\n## Tests\n- k_of_n with k=2, 3 branches, 2 succeed → SUCCESS\n- k_of_n with k=2, 3 branches, 1 succeeds → FAIL\n- quorum with fraction 0.5, 4 branches, 3 succeed → SUCCESS\n- quorum with fraction 0.5, 4 branches, 1 succeeds → FAIL","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-11T00:33:21.699106Z","created_by":"jhugman","updated_at":"2026-02-11T01:25:30.808106Z","closed_at":"2026-02-11T01:25:30.808049Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-1e0.1","depends_on_id":"df-1e0","type":"parent-child","created_at":"2026-02-11T00:33:21.699106Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-1e0.2","title":"Implement max_parallel bounded parallelism","description":"Spec §4.8 pseudocode: \"FOR EACH branch IN branches (up to max_parallel at a time)\"\n\n`max_parallel = integer(node.attrs.get(\"max_parallel\", \"4\"))`\n\nCurrently all branches launch via Promise.allSettled() with no concurrency limit. Add a semaphore or chunked execution to respect `max_parallel`.\n\n## Files\n- `packages/attractor-core/src/handlers/handlers.ts` — ParallelHandler, add concurrency limiter\n- `packages/attractor-core/tests/parallel-subgraph.test.ts` — add test\n\n## Tests\n- max_parallel=1 executes branches sequentially (verify via timing or execution order)\n- max_parallel=2 with 4 branches runs at most 2 concurrently","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-11T00:33:21.726204Z","created_by":"jhugman","updated_at":"2026-02-11T01:25:30.843037Z","closed_at":"2026-02-11T01:25:30.842989Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-1e0.2","depends_on_id":"df-1e0","type":"parent-child","created_at":"2026-02-11T00:33:21.726204Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-1e0.3","title":"Implement error_policy for parallel handler","description":"Spec §4.8 error policies:\n- `fail_fast` — \"Cancel all remaining branches on first failure.\"\n- `continue` — \"Continue remaining branches. Collect all results.\" (current default behavior)\n- `ignore` — \"Ignore failures entirely. Return only successful results.\"\n\n`error_policy = node.attrs.get(\"error_policy\", \"continue\")`\n\n## Files\n- `packages/attractor-core/src/handlers/handlers.ts` — ParallelHandler, read error_policy attr, implement fail_fast (abort on first FAIL) and ignore (filter FAILs from results)\n- `packages/attractor-core/tests/parallel-subgraph.test.ts` — add tests\n\n## Tests\n- error_policy=fail_fast: first branch fails → remaining branches not executed → FAIL\n- error_policy=continue: one branch fails → all branches run → result reflects all\n- error_policy=ignore: failed branches excluded from success/fail count","status":"closed","priority":3,"issue_type":"feature","created_at":"2026-02-11T00:33:21.749393Z","created_by":"jhugman","updated_at":"2026-02-11T01:25:30.862602Z","closed_at":"2026-02-11T01:25:30.862554Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-1e0.3","depends_on_id":"df-1e0","type":"parent-child","created_at":"2026-02-11T00:33:21.749393Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-1ig","title":"Epic 4: Condition Expression Language","description":"Condition parser, variable resolution, evaluateCondition(), parseCondition().","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-10T19:03:14.954348Z","created_by":"jhugman","updated_at":"2026-02-10T19:16:09.194919Z","closed_at":"2026-02-10T19:16:09.194903Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"labels":["conditions"]}
{"id":"df-22a","title":"Epic 7: Node Handlers","description":"9 handler types + HandlerRegistry + Interviewer interface with 5 implementations.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-10T19:03:15.009313Z","created_by":"jhugman","updated_at":"2026-02-10T19:16:09.260375Z","closed_at":"2026-02-10T19:16:09.260360Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"labels":["handlers"]}
{"id":"df-2by","title":"Epic 3: Validation and Linting","description":"12 lint rules, Diagnostic model, LintRule interface, validate(), validateOrRaise().","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-10T19:03:14.931682Z","created_by":"jhugman","updated_at":"2026-02-10T19:16:09.174731Z","closed_at":"2026-02-10T19:16:09.174714Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"labels":["validation"]}
{"id":"df-2c9","title":"Epic 12: Prompt Resolution — @file includes and /command lookups","description":"Implement prompt resolution per spec §9.2.1. The prompt attribute supports three forms: inline text (current), @path file includes (relative to DOT file), and /command lookups (search .attractor/commands/ with : as directory separator). Includes ATTRACTOR_COMMANDS_PATH env var, $ARGUMENTS substitution, and two new validation rules (prompt_file_exists, prompt_command_exists).","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-11T00:14:27.892813Z","created_by":"jhugman","updated_at":"2026-02-11T01:15:59.111832Z","closed_at":"2026-02-11T01:15:59.111783Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"df-2c9.1","title":"Implement @file prompt includes","description":"Add a PromptResolutionTransform that runs before VariableExpansionTransform. When a node's prompt starts with @, read the referenced file relative to the DOT file's directory and replace the prompt with the file contents.\n\nRequires: the DOT file path must be threaded through preparePipeline() so the transform knows the base directory.\n\nAdd prompt_file_exists validation: if the @path file doesn't exist, produce an ERROR diagnostic.\n\nTests: @file resolves correctly, missing file errors, empty file produces empty prompt (falls back to label), relative paths work.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-11T00:14:36.831003Z","created_by":"jhugman","updated_at":"2026-02-11T01:15:59.036976Z","closed_at":"2026-02-11T01:15:59.036919Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-2c9.1","depends_on_id":"df-2c9","type":"parent-child","created_at":"2026-02-11T00:14:36.831003Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-2c9.2","title":"Implement /command prompt lookups","description":"Extend the PromptResolutionTransform to handle /command prompts. When a node's prompt starts with /, split into command name and args. Translate : to / in the command name. Search for {name}.md in:\n\n1. {dot_file_dir}/{name}.md\n2. {project}/.attractor/commands/{name}.md\n3. ~/.attractor/commands/{name}.md\n\nWhere {project} is found by walking up from the DOT file looking for .git/ or .attractor/.\n\nReplace the prompt with the file contents. Set $ARGUMENTS in the variables map to everything after the command name.\n\nAdd prompt_command_exists validation: if no .md file found in the search path, produce an ERROR diagnostic with all searched paths listed.\n\nTests: /command resolves, /my:cmd maps to my/cmd.md, $ARGUMENTS substitution, missing command errors, search path priority.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-11T00:14:41.434175Z","created_by":"jhugman","updated_at":"2026-02-11T01:15:59.067885Z","closed_at":"2026-02-11T01:15:59.067837Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-2c9.2","depends_on_id":"df-2c9","type":"parent-child","created_at":"2026-02-11T00:14:41.434175Z","created_by":"jhugman","metadata":"{}","thread_id":""},{"issue_id":"df-2c9.2","depends_on_id":"df-2c9.1","type":"blocks","created_at":"2026-02-11T00:14:55.094777Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-2c9.3","title":"Support ATTRACTOR_COMMANDS_PATH env var","description":"Read the ATTRACTOR_COMMANDS_PATH environment variable (comma-separated directory names). These directories are searched after .attractor/commands/ at each scope level (project, home).\n\nExample: ATTRACTOR_COMMANDS_PATH=.claude/commands adds {project}/.claude/commands/ and ~/.claude/commands/ to the search path.\n\nTests: env var adds paths, multiple comma-separated dirs, empty env var is no-op.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-11T00:14:43.614518Z","created_by":"jhugman","updated_at":"2026-02-11T01:15:59.090231Z","closed_at":"2026-02-11T01:15:59.090187Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-2c9.3","depends_on_id":"df-2c9","type":"parent-child","created_at":"2026-02-11T00:14:43.614518Z","created_by":"jhugman","metadata":"{}","thread_id":""},{"issue_id":"df-2c9.3","depends_on_id":"df-2c9.2","type":"blocks","created_at":"2026-02-11T00:14:55.125687Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-2he","title":"Epic 1: DOT Parser","description":"AST types, lexer, recursive-descent parser for DOT subset.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-10T19:03:14.886550Z","created_by":"jhugman","updated_at":"2026-02-10T19:16:09.126439Z","closed_at":"2026-02-10T19:16:09.126397Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"labels":["critical-path","parser"]}
{"id":"df-2jt","title":"Epic 15: Context fidelity — edge resolution, default mismatch, thread resolution, resume degradation","description":"Fix fidelity resolution to match spec §5.4 and §5.3.\n\nFour gaps:\n1. Edge fidelity attribute should take highest precedence (spec §5.4)\n2. Default fidelity should be `compact`, not `full` (spec §5.4)\n3. Thread resolution for `full` fidelity mode (spec §5.4)\n4. Resume fidelity degradation — full → summary:high on first hop after resume (spec §5.3 point 6)","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-11T00:33:28.852858Z","created_by":"jhugman","updated_at":"2026-02-11T01:31:30.377025Z","closed_at":"2026-02-11T01:31:30.376967Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"df-2jt.1","title":"Fix default fidelity: spec says compact, implementation uses full","description":"Spec §5.4, fidelity resolution precedence:\n> 1. Edge `fidelity` attribute (on the incoming edge)\n> 2. Target node `fidelity` attribute\n> 3. Graph `default_fidelity` attribute\n> 4. Default: `compact`\n\n`resolveEffectiveFidelity()` currently falls back to `\"full\"` when both node and graph are empty. Should fall back to `\"compact\"`.\n\n## Files\n- `packages/attractor-core/src/state/fidelity.ts` — change default return from `\"full\"` to `\"compact\"`\n- `packages/attractor-core/tests/fidelity.test.ts` — update `resolveEffectiveFidelity` tests: both empty → compact\n\n## Tests\n- resolveEffectiveFidelity(\"\", \"\") → \"compact\" (currently returns \"full\")","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-11T00:33:52.905710Z","created_by":"jhugman","updated_at":"2026-02-11T01:31:30.288388Z","closed_at":"2026-02-11T01:31:30.288335Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-2jt.1","depends_on_id":"df-2jt","type":"parent-child","created_at":"2026-02-11T00:33:52.905710Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-2jt.2","title":"Implement edge fidelity resolution (highest precedence)","description":"Spec 5.4, fidelity resolution precedence: (1) Edge fidelity attribute (on the incoming edge), (2) Target node fidelity attribute, (3) Graph default_fidelity attribute, (4) Default: compact.\n\nCurrently resolveEffectiveFidelity(nodeFidelity, graphDefault) only considers node and graph. The incoming edge fidelity attribute is never consulted.\n\nThe runner must pass the traversed edge fidelity into resolution, and it must take highest precedence.\n\n## Files\n- packages/attractor-core/src/state/fidelity.ts -- add edgeFidelity param to resolveEffectiveFidelity()\n- packages/attractor-core/src/engine/runner.ts -- pass selected edge fidelity into resolution\n- packages/attractor-core/src/handlers/handlers.ts -- CodergenHandler receives resolved fidelity\n- packages/attractor-core/tests/fidelity.test.ts -- add tests\n\n## Tests\n- edge fidelity set -> used regardless of node/graph values\n- edge fidelity empty -> falls through to node -> graph -> default","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-11T00:34:01.150233Z","created_by":"jhugman","updated_at":"2026-02-11T01:31:30.313874Z","closed_at":"2026-02-11T01:31:30.313822Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-2jt.2","depends_on_id":"df-2jt","type":"parent-child","created_at":"2026-02-11T00:34:01.150233Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-2jt.3","title":"Implement thread resolution for full fidelity mode","description":"Spec 5.4: When fidelity resolves to full, the engine determines a thread key for session reuse: (1) Target node thread_id attribute, (2) Edge thread_id attribute, (3) Graph-level default thread, (4) Derived class from enclosing subgraph, (5) Fallback: previous node ID. Nodes that share the same thread key reuse the same LLM session.\n\nThread resolution is not currently implemented. The thread_id attribute is parsed and stored on nodes/edges but never used for session management.\n\n## Files\n- packages/attractor-core/src/engine/runner.ts -- resolve thread key per precedence, pass to handler\n- packages/attractor-core/src/handlers/handlers.ts -- CodergenHandler uses thread key for session reuse\n- packages/attractor-core/tests/integration.test.ts -- add tests\n\n## Tests\n- two nodes with same thread_id -> same session key resolved\n- node thread_id overrides edge thread_id\n- fallback to previous node ID when no thread_id set","status":"closed","priority":3,"issue_type":"feature","created_at":"2026-02-11T00:34:07.447455Z","created_by":"jhugman","updated_at":"2026-02-11T01:31:30.334495Z","closed_at":"2026-02-11T01:31:30.334448Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-2jt.3","depends_on_id":"df-2jt","type":"parent-child","created_at":"2026-02-11T00:34:07.447455Z","created_by":"jhugman","metadata":"{}","thread_id":""},{"issue_id":"df-2jt.3","depends_on_id":"df-2jt.2","type":"blocks","created_at":"2026-02-11T00:35:32.112486Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-2jt.4","title":"Implement resume fidelity degradation","description":"Spec 5.3 point 6: If the previous node used full fidelity, degrade to summary:high for the first resumed node, because in-memory LLM sessions cannot be serialized. After this one degraded hop, subsequent nodes may use full fidelity again.\n\nWhen resuming from checkpoint, if the last completed node was using full fidelity, the first node to execute after resume should have its fidelity forced to summary:high.\n\n## Files\n- packages/attractor-core/src/engine/runner.ts -- after checkpoint restore, set a flag to degrade fidelity on first execution\n- packages/attractor-core/tests/integration.test.ts -- add test\n\n## Tests\n- resume from checkpoint where last node used full fidelity -> first resumed node resolves to summary:high\n- second node after resume -> normal fidelity resolution","status":"closed","priority":3,"issue_type":"feature","created_at":"2026-02-11T00:34:13.616882Z","created_by":"jhugman","updated_at":"2026-02-11T01:31:30.356215Z","closed_at":"2026-02-11T01:31:30.356160Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-2jt.4","depends_on_id":"df-2jt","type":"parent-child","created_at":"2026-02-11T00:34:13.616882Z","created_by":"jhugman","metadata":"{}","thread_id":""},{"issue_id":"df-2jt.4","depends_on_id":"df-2jt.2","type":"blocks","created_at":"2026-02-11T00:35:32.132226Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-2si","title":"Epic 9: Pi-Mono Adapter","description":"LLM backend wrapping pi-mono Agent as CodergenBackend.","status":"closed","priority":3,"issue_type":"epic","created_at":"2026-02-10T19:03:15.044222Z","created_by":"jhugman","updated_at":"2026-02-10T19:33:41.616770Z","closed_at":"2026-02-10T19:33:41.616745Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"labels":["adapter"]}
{"id":"df-2xu","title":"Epic 0: Project Scaffolding","description":"Initialize pnpm workspace monorepo with 3 packages (attractor-core, llm-adapter, attractor-cli). Configure TypeScript, vitest.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-10T19:03:04.713733Z","created_by":"jhugman","updated_at":"2026-02-10T19:03:19.925947Z","closed_at":"2026-02-10T19:03:19.925932Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"labels":["scaffolding"]}
{"id":"df-31m","title":"Epic 5: State Primitives","description":"Context, Outcome, StageStatus, Checkpoint, ArtifactStore.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-10T19:03:14.972903Z","created_by":"jhugman","updated_at":"2026-02-10T19:16:09.213791Z","closed_at":"2026-02-10T19:16:09.213776Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"labels":["state"]}
{"id":"df-32d","title":"Implement preamble transform (runtime context carryover)","description":"Spec 9.2: Preamble Transform -- Synthesizes context carryover text for stages that do not use full fidelity. Applied at execution time (not at parse time) since it depends on runtime state.\n\nWhen a node uses truncate, compact, or summary:* fidelity, the engine should synthesize a preamble from the context snapshot (filtered per fidelity mode) and prepend it to the prompt. This gives the LLM enough context to continue work without full conversation history.\n\n## Files\n- packages/attractor-core/src/engine/runner.ts -- before handler execution, if fidelity is not full, synthesize preamble and prepend to node prompt\n- packages/attractor-core/src/handlers/handlers.ts -- CodergenHandler accepts optional preamble\n- packages/attractor-core/tests/integration.test.ts -- add test\n\n## Tests\n- node with compact fidelity -> prompt includes synthesized preamble from context\n- node with full fidelity -> no preamble prepended\n- preamble content reflects applyFidelity output for the resolved mode","status":"open","priority":3,"issue_type":"feature","created_at":"2026-02-11T00:34:33.745939Z","created_by":"jhugman","updated_at":"2026-02-11T00:34:33.745939Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"df-32e","title":"Epic 2: Graph Model","description":"Semantic Graph/Node/Edge types. AST-to-Graph builder. Convenience methods.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-10T19:03:14.908744Z","created_by":"jhugman","updated_at":"2026-02-10T19:16:09.155322Z","closed_at":"2026-02-10T19:16:09.155306Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"labels":["model"]}
{"id":"df-3er","title":"Epic 18: Coding Agent Loop — programmable agentic loop for coding tasks","description":"Implement the Coding Agent Loop per docs/specs/coding-agent-loop-spec.md.\n\nA new package (@attractor/agent) that provides a programmable agentic loop pairing an LLM with developer tools. Depends on the Unified LLM Client (Epic 17). This is a library, not a CLI — the host application controls every step.\n\nKey components:\n- Session management with lifecycle states (IDLE, PROCESSING, AWAITING_INPUT, CLOSED)\n- Core agentic loop: LLM call → tool execution → loop until natural completion\n- Provider-aligned toolsets (OpenAI/codex-rs, Anthropic/Claude Code, Gemini/gemini-cli)\n- ExecutionEnvironment interface (local, Docker, K8s, WASM, SSH)\n- Tool output truncation (character-based first, then line-based)\n- Layered system prompt construction with project doc discovery\n- Subagent spawning for parallel/scoped work\n- Steering and follow-up message injection\n- Loop detection and warning injection\n- Event-driven architecture for UI/logging integration\n\nNew package: packages/agent/","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-11T00:56:36.082374Z","created_by":"jhugman","updated_at":"2026-02-11T00:56:36.082374Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"df-3er.1","title":"Session, core agentic loop, and turn types","description":"Implement the Session, SessionConfig, core agentic loop, and turn types.\n\n**Spec references (coding-agent-loop-spec.md):**\n\n§2.1 Session:\n> \"The Session is the central orchestrator. It holds the conversation state, dispatches tool calls, manages the event stream, and enforces limits.\"\n> Fields: id (UUID), provider_profile, execution_env, history (List of Turn), event_emitter, config, state, llm_client, steering_queue, followup_queue, subagents\n\n§2.2 SessionConfig:\n> max_turns (0=unlimited), max_tool_rounds_per_input (200), default_command_timeout_ms (10000), max_command_timeout_ms (600000), reasoning_effort (\"low\"/\"medium\"/\"high\"/null), tool_output_limits (per-tool char limits), enable_loop_detection (true), loop_detection_window (10), max_subagent_depth (1)\n\n§2.3 Session Lifecycle:\n> States: IDLE, PROCESSING, AWAITING_INPUT, CLOSED\n> Transitions: IDLE→PROCESSING (submit), PROCESSING→PROCESSING (tool loop), PROCESSING→AWAITING_INPUT (model asks question), PROCESSING→IDLE (completion), PROCESSING→CLOSED (error), any→CLOSED (abort)\n\n§2.4 Turn Types:\n> UserTurn: content, timestamp\n> AssistantTurn: content, tool_calls, reasoning, usage, response_id, timestamp\n> ToolResultsTurn: results (List of ToolResult), timestamp\n> SystemTurn: content, timestamp\n> SteeringTurn: content, timestamp\n\n§2.5 The Core Agentic Loop (process_input):\n> 1. Check limits (round limit, turn limit, abort)\n> 2. Build LLM request using provider profile\n> 3. Call LLM via Client.complete()\n> 4. Record assistant turn\n> 5. If no tool calls → natural completion, break\n> 6. Execute tool calls through execution environment\n> 7. Drain steering messages\n> 8. Loop detection check\n> Continue until natural completion or limit hit\n\n§2.8 Stop Conditions:\n> Natural completion (text only, no tool calls), round limit, turn limit, abort signal, unrecoverable error\n\n**Files to create:**\n- packages/agent/package.json, tsconfig.json — new package scaffold\n- packages/agent/src/session.ts — Session class, SessionConfig, SessionState\n- packages/agent/src/turns.ts — UserTurn, AssistantTurn, ToolResultsTurn, SystemTurn, SteeringTurn\n- packages/agent/src/loop.ts — process_input(), drain_steering(), execute_tool_calls(), execute_single_tool()\n- packages/agent/src/index.ts — public API barrel\n\n**Tests (packages/agent/tests/session.test.ts):**\n- Session starts in IDLE state\n- submit() transitions to PROCESSING\n- Natural completion: model responds with text only → loop exits → back to IDLE\n- Round limit: max_tool_rounds_per_input stops the loop\n- Turn limit: max_turns across session stops the loop\n- Abort signal: cancellation stops the loop → CLOSED\n- Multiple sequential inputs: submit → complete → submit again\n- State transitions match the spec diagram\n\n**Tests (packages/agent/tests/loop.test.ts):**\n- Core loop: LLM returns text only → exits after 1 call\n- Core loop: LLM returns tool calls → executes tools → calls LLM again → text → exits\n- Core loop: multi-round tool usage (3+ rounds) before natural completion\n- Tool execution: single tool call dispatched through registry\n- Tool execution: parallel tool calls when profile supports it\n- Tool execution: unknown tool returns error result (not exception)\n- Tool execution: tool error caught and returned as is_error=true result\n- drain_steering injects queued messages as SteeringTurns between tool rounds\n- History records all turns in correct order","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-11T00:58:59.560366Z","created_by":"jhugman","updated_at":"2026-02-11T00:58:59.560366Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-3er.1","depends_on_id":"df-3er","type":"parent-child","created_at":"2026-02-11T00:58:59.560366Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-3er.2","title":"ExecutionEnvironment interface and LocalExecutionEnvironment","description":"Implement the ExecutionEnvironment interface and LocalExecutionEnvironment.\n\n**Spec references (coding-agent-loop-spec.md):**\n\n§4.1 The Execution Environment Abstraction:\n> \"All tool operations pass through an ExecutionEnvironment interface. This decouples tool logic from where it runs.\"\n> Interface methods:\n>   File operations: read_file(path, offset?, limit?), write_file(path, content), file_exists(path), list_directory(path, depth)\n>   Command execution: exec_command(command, timeout_ms, working_dir?, env_vars?)\n>   Search: grep(pattern, path, options), glob(pattern, path)\n>   Lifecycle: initialize(), cleanup()\n>   Metadata: working_directory(), platform(), os_version()\n> ExecResult: stdout, stderr, exit_code, timed_out, duration_ms\n> DirEntry: name, is_dir, size\n\n§4.2 LocalExecutionEnvironment (Required Implementation):\n> \"File operations: Direct filesystem access. Paths are resolved relative to working_directory().\"\n> Command execution:\n>   \"Spawn in a new process group for clean killability\"\n>   \"Use the platform's default shell (/bin/bash -c on Linux/macOS)\"\n>   \"Enforce timeout: on timeout, send SIGTERM to the process group, wait 2 seconds, then SIGKILL\"\n>   \"Capture stdout and stderr separately, then combine for the result\"\n>   \"Record wall-clock duration\"\n> Environment variable filtering:\n>   \"Exclude variables matching: *_API_KEY, *_SECRET, *_TOKEN, *_PASSWORD, *_CREDENTIAL (case-insensitive)\"\n>   \"Always include: PATH, HOME, USER, SHELL, LANG, TERM, TMPDIR, GOPATH, CARGO_HOME, NVM_DIR, etc.\"\n>   \"Customizable via an env var policy: inherit all, inherit none, or inherit core only\"\n> Search: \"Use ripgrep for grep if available, fall back to language-native regex. Use filesystem globbing for glob.\"\n\n§4.4 Composing Environments:\n> LoggingExecutionEnvironment(inner) — wraps with logging\n> ReadOnlyExecutionEnvironment(inner) — rejects writes\n\n**Files to create:**\n- packages/agent/src/env/types.ts — ExecutionEnvironment interface, ExecResult, DirEntry, GrepOptions\n- packages/agent/src/env/local.ts — LocalExecutionEnvironment class\n- packages/agent/src/env/index.ts — barrel\n\n**Tests (packages/agent/tests/env.test.ts):**\n- read_file reads a real file with line numbers\n- read_file respects offset and limit\n- read_file returns error for nonexistent file\n- write_file creates file and parent directories\n- file_exists returns true for existing file, false otherwise\n- list_directory returns DirEntry list with correct is_dir flags\n- exec_command runs a command and returns stdout, stderr, exit_code\n- exec_command records wall-clock duration_ms\n- exec_command times out after timeout_ms: SIGTERM → wait 2s → SIGKILL\n- exec_command timed_out flag set true on timeout\n- exec_command filters sensitive env vars (*_API_KEY, *_SECRET, *_TOKEN, *_PASSWORD)\n- exec_command preserves safe env vars (PATH, HOME, USER, SHELL, LANG)\n- grep finds pattern in files (regex support)\n- glob finds files matching pattern\n- working_directory() returns configured cwd\n- platform() returns \"darwin\"/\"linux\"/\"windows\"\n- cleanup() is callable without error","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-11T00:59:00.456672Z","created_by":"jhugman","updated_at":"2026-02-11T00:59:00.456672Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-3er.2","depends_on_id":"df-3er","type":"parent-child","created_at":"2026-02-11T00:59:00.456672Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-3er.3","title":"Provider profiles, ToolRegistry, and shared/provider-specific tools","description":"Implement the ProviderProfile interface, ToolRegistry, and all three provider profiles (OpenAI, Anthropic, Gemini).\n\n**Spec references (coding-agent-loop-spec.md):**\n\n§3.1 The Provider Alignment Principle:\n> \"Models are trained and optimized for specific tool interfaces.\"\n> \"The initial base for each provider should be a 1:1 copy of the provider's reference agent — the exact same system prompt, the exact same tool definitions, byte for byte.\"\n\n§3.2 ProviderProfile Interface:\n> id, model, tool_registry\n> build_system_prompt(environment, project_docs) -> String\n> tools() -> List of ToolDefinition\n> provider_options() -> Map or None\n> Capability flags: supports_reasoning, supports_streaming, supports_parallel_tool_calls, context_window_size\n\n§3.3 Shared Core Tools (all profiles):\n> read_file: file_path, offset?, limit? → line-numbered content\n> write_file: file_path, content → confirmation\n> edit_file: file_path, old_string, new_string, replace_all? → confirmation\n> shell: command, timeout_ms?, description? → stdout+stderr, exit_code, duration\n> grep: pattern, path?, glob_filter?, case_insensitive?, max_results? → matching lines\n> glob: pattern, path? → file paths sorted by mtime\n\n§3.4 OpenAI Profile (codex-rs-aligned):\n> \"Key difference: apply_patch replaces edit_file and write_file for file modifications.\"\n> Tools: read_file, apply_patch (v4a format), write_file (for new files), shell (10s timeout), grep, glob, subagent tools\n> \"System prompt: Should mirror the codex-rs system prompt structure.\"\n\n§3.5 Anthropic Profile (Claude Code-aligned):\n> \"Key difference: edit_file with old_string/new_string is the native editing format.\"\n> Tools: read_file, write_file, edit_file, shell (120s default timeout), grep (ripgrep-backed), glob, subagent tools\n> \"System prompt: Should mirror the Claude Code system prompt structure.\"\n\n§3.6 Gemini Profile (gemini-cli-aligned):\n> Tools: read_file, read_many_files, write_file, edit_file, shell (10s timeout), grep, glob, list_dir, web_search?, web_fetch?, subagent tools\n> \"System prompt: Should mirror the gemini-cli system prompt structure.\"\n\n§3.7 Extending Profiles with Custom Tools:\n> \"After a provider profile is loaded, additional tools can be registered.\"\n> \"Name collisions are resolved by latest-wins.\"\n\n§3.8 Tool Registry:\n> ToolDefinition: name, description, parameters (JSON Schema)\n> RegisteredTool: definition, executor function\n> ToolRegistry: register, unregister, get, definitions(), names()\n> Execution pipeline: LOOKUP → VALIDATE → EXECUTE → TRUNCATE → EMIT → RETURN\n\nAppendix A: apply_patch v4a Format Reference:\n> Grammar: patch = \"*** Begin Patch\\n\" operations \"*** End Patch\\n\"\n> Operations: add_file, delete_file, update_file (with hunks), move (rename)\n> Hunk matching uses context hints + context lines; fuzzy matching on failure\n\n**Files to create:**\n- packages/agent/src/profiles/types.ts — ProviderProfile interface, ToolDefinition, RegisteredTool, ToolRegistry class\n- packages/agent/src/profiles/openai.ts — OpenAI profile with codex-rs-aligned tools, apply_patch implementation\n- packages/agent/src/profiles/anthropic.ts — Anthropic profile with Claude Code-aligned tools\n- packages/agent/src/profiles/gemini.ts — Gemini profile with gemini-cli-aligned tools\n- packages/agent/src/profiles/shared-tools.ts — Shared core tool executors (read_file, write_file, edit_file, shell, grep, glob)\n- packages/agent/src/profiles/index.ts — barrel\n\n**Tests (packages/agent/tests/profiles.test.ts):**\n- ToolRegistry: register, get, unregister, definitions(), names()\n- ToolRegistry: custom tool overrides profile default (latest-wins)\n- OpenAI profile: tools list includes apply_patch, read_file, write_file, shell, grep, glob\n- OpenAI profile: does NOT include edit_file (replaced by apply_patch)\n- Anthropic profile: tools list includes edit_file, read_file, write_file, shell, grep, glob\n- Anthropic profile: does NOT include apply_patch\n- Gemini profile: tools list includes list_dir, web_search, web_fetch extras\n- All profiles: build_system_prompt produces non-empty string\n- All profiles: provider_options returns correct provider key\n\n**Tests (packages/agent/tests/apply-patch.test.ts):**\n- Add file: creates new file with prefixed lines\n- Delete file: removes file\n- Update file: single hunk with context matching\n- Update file: multi-hunk changes\n- Update + rename: modify and move in one operation\n- Fuzzy matching: whitespace normalization on match failure\n- Error: file not found for update\n- Error: context lines don't match (verification failure)\n\n**Tests (packages/agent/tests/shared-tools.test.ts):**\n- read_file: returns line-numbered content\n- read_file: respects offset/limit\n- write_file: creates parent directories\n- edit_file: replaces exact string match\n- edit_file: replace_all replaces all occurrences\n- edit_file: error when old_string not found\n- edit_file: error when old_string matches multiple (replace_all=false)\n- shell: returns stdout, stderr, exit_code, duration\n- shell: timeout produces error with partial output\n- grep: regex pattern matching with line numbers\n- glob: file pattern matching sorted by mtime","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-11T00:59:01.606174Z","created_by":"jhugman","updated_at":"2026-02-11T00:59:01.606174Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-3er.3","depends_on_id":"df-3er","type":"parent-child","created_at":"2026-02-11T00:59:01.606174Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-3er.4","title":"Tool output truncation — character-based and line-based","description":"Implement tool output truncation (character-based and line-based).\n\n**Spec references (coding-agent-loop-spec.md):**\n\n§5.1 Tool Output Truncation:\n> \"When tool output exceeds the configured limit, it MUST be truncated before being sent to the LLM. The full output is always available via the event stream.\"\n> head_tail mode: \"half = max_chars / 2; RETURN output[0..half] + WARNING + output[-half..]\"\n> tail mode: \"RETURN WARNING + output[-max_chars..]\"\n> Warning message: \"[WARNING: Tool output was truncated. N characters were removed from the middle. The full output is available in the event stream. If you need to see specific parts, re-run the tool with more targeted parameters.]\"\n\n§5.2 Default Output Size Limits:\n> read_file: 50,000 chars, head_tail\n> shell: 30,000 chars, head_tail\n> grep: 20,000 chars, tail\n> glob: 20,000 chars, tail\n> edit_file: 10,000 chars, tail\n> apply_patch: 10,000 chars, tail\n> write_file: 1,000 chars, tail\n> spawn_agent: 20,000 chars, head_tail\n\n§5.3 Truncation Order:\n> \"Character-based truncation is the primary safeguard and MUST always run first.\"\n> \"Line-based truncation is a secondary readability pass that runs after character truncation.\"\n> \"A file could have 2 lines that are each 10MB. Line-based truncation would see 'only 2 lines' and pass it through untouched.\"\n> Pipeline: truncate_output(char-based) → truncate_lines(line-based)\n\nDefault line limits (after character truncation):\n> shell: 256 lines, grep: 200 lines, glob: 500 lines\n> read_file: None, edit_file: None\n\nLine-based truncation (head/tail split):\n> head_count = max_lines / 2, tail_count = max_lines - head_count\n> \"[... N lines omitted ...]\"\n\n§5.2: \"These defaults are overridable via SessionConfig.tool_output_limits.\"\n\n**Files to create:**\n- packages/agent/src/truncation.ts — truncate_output(), truncate_lines(), truncate_tool_output(), DEFAULT_TOOL_LIMITS, DEFAULT_LINE_LIMITS, DEFAULT_TRUNCATION_MODES\n\n**Tests (packages/agent/tests/truncation.test.ts):**\n- Character truncation (head_tail): output under limit passes through unchanged\n- Character truncation (head_tail): output over limit splits at halfway with warning marker\n- Character truncation (tail): output over limit keeps tail with warning prefix\n- Warning message includes correct character count removed\n- Line truncation: under limit passes through unchanged\n- Line truncation: over limit keeps head and tail halves with omitted marker\n- Pipeline: character truncation runs FIRST then line truncation\n- Pathological case: 2 lines of 10MB each — character truncation handles it\n- Default limits match spec table (read_file=50k, shell=30k, grep=20k, etc.)\n- Per-tool overrides via config are respected\n- Per-tool line limits: shell=256, grep=200, glob=500\n- Combined: 100k chars of 500-line shell output → char-truncated to 30k → line-truncated to 256 lines","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-11T00:59:02.491553Z","created_by":"jhugman","updated_at":"2026-02-11T00:59:02.491553Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-3er.4","depends_on_id":"df-3er","type":"parent-child","created_at":"2026-02-11T00:59:02.491553Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-3er.5","title":"Layered system prompt construction and project document discovery","description":"Implement layered system prompt construction and project document discovery.\n\n**Spec references (coding-agent-loop-spec.md):**\n\n§6.1 Layered System Prompt Construction:\n> \"final_system_prompt =\n>   1. Provider-specific base instructions (from ProviderProfile)\n>   2. Environment context (platform, git, working dir, date, model info)\n>   3. Tool descriptions (from the active profile's tool set)\n>   4. Project-specific instructions (AGENTS.md, CLAUDE.md, GEMINI.md, etc.)\n>   5. User instructions override (appended last, highest priority)\"\n\n§6.2 Provider-Specific Base Instructions:\n> \"OpenAI profile: Mirror codex-rs system prompt. Cover identity, tool usage (especially apply_patch), coding best practices.\"\n> \"Anthropic profile: Mirror Claude Code system prompt. Cover identity, tool selection guidance (read before edit), the edit_file format.\"\n> \"Gemini profile: Mirror gemini-cli system prompt. Cover identity, tool usage, GEMINI.md conventions.\"\n\n§6.3 Environment Context Block:\n> \"<environment>\n> Working directory: ...\n> Is git repository: true/false\n> Git branch: ...\n> Platform: darwin/linux/windows\n> OS version: ...\n> Today's date: YYYY-MM-DD\n> Model: ...\n> Knowledge cutoff: ...\n> </environment>\"\n\n§6.4 Git Context:\n> \"Snapshot at session start. Include: current branch, short status (modified/untracked file count), recent commit messages (last 5-10).\"\n\n§6.5 Project Document Discovery:\n> Walk from git root to cwd. Recognized files:\n>   AGENTS.md (universal), CLAUDE.md (Anthropic), GEMINI.md (Gemini), .codex/instructions.md (OpenAI)\n> \"Root-level files are loaded first. Subdirectory files are appended (deeper = higher precedence).\"\n> \"Total byte budget: 32KB. If exceeded, truncate with marker.\"\n> \"Only load files matching the active provider profile (e.g., Anthropic profile loads AGENTS.md and CLAUDE.md, not GEMINI.md)\"\n> \"AGENTS.md is always loaded regardless of provider\"\n\n**Files to create:**\n- packages/agent/src/prompts/builder.ts — buildSystemPrompt() assembling all 5 layers\n- packages/agent/src/prompts/environment.ts — buildEnvironmentContext() with platform, git, date\n- packages/agent/src/prompts/discovery.ts — discoverProjectDocs() walking git root to cwd\n- packages/agent/src/prompts/index.ts — barrel\n\n**Tests (packages/agent/tests/prompts.test.ts):**\n- buildSystemPrompt includes provider base instructions\n- buildSystemPrompt includes environment context block with correct fields\n- buildSystemPrompt includes tool descriptions\n- buildSystemPrompt includes project docs\n- buildSystemPrompt: user instructions appended last\n\n**Tests (packages/agent/tests/discovery.test.ts):**\n- Discovers AGENTS.md at git root\n- Discovers provider-specific file (CLAUDE.md for Anthropic)\n- Does NOT load GEMINI.md for Anthropic profile\n- Does NOT load CLAUDE.md for Gemini profile\n- AGENTS.md loaded for all providers\n- Root-level files loaded before subdirectory files\n- Deeper subdirectory files have higher precedence\n- Total byte budget enforced at 32KB with truncation marker\n- Returns empty when no project docs found\n\n**Tests (packages/agent/tests/environment.test.ts):**\n- Environment context includes working_directory\n- Environment context includes platform\n- Environment context includes git branch (when in git repo)\n- Environment context includes today's date in YYYY-MM-DD format\n- Environment context includes model display name","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-11T00:59:03.332648Z","created_by":"jhugman","updated_at":"2026-02-11T00:59:03.332648Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-3er.5","depends_on_id":"df-3er","type":"parent-child","created_at":"2026-02-11T00:59:03.332648Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-3er.6","title":"Steering, follow-up queues, event system, and loop detection","description":"Implement steering, follow-up queues, event system, and loop detection.\n\n**Spec references (coding-agent-loop-spec.md):**\n\n§2.6 Steering:\n> \"session.steer(message) — Queue a message to be injected after the current tool round completes. The message becomes a SteeringTurn in the history, converted to a user message for the LLM on the next call.\"\n> \"session.follow_up(message) — Queue a message to be processed after the current input is fully handled. Triggers a new processing cycle.\"\n> \"SteeringTurns are converted to user-role messages when building the LLM request.\"\n\n§2.9 Event System:\n> \"Every agent action emits a typed event. Events are delivered via an async iterator.\"\n> SessionEvent: kind, timestamp, session_id, data\n> EventKind: SESSION_START, SESSION_END, USER_INPUT, ASSISTANT_TEXT_START, ASSISTANT_TEXT_DELTA, ASSISTANT_TEXT_END, TOOL_CALL_START, TOOL_CALL_OUTPUT_DELTA, TOOL_CALL_END, STEERING_INJECTED, TURN_LIMIT, LOOP_DETECTION, ERROR\n> \"TOOL_CALL_END event carries the FULL untruncated tool output. The LLM receives the truncated version.\"\n\n§2.10 Loop Detection:\n> \"Track the signature of each tool call (name + arguments hash). If the last N calls contain a repeating pattern, inject a warning as a SteeringTurn.\"\n> detect_loop(history, window_size): check for repeating patterns of length 1, 2, or 3\n> Default window: 10 consecutive calls\n> Warning: \"Loop detected: the last N tool calls follow a repeating pattern. Try a different approach.\"\n\n§2.7 Reasoning Effort:\n> \"reasoning_effort is passed through to the LLM SDK Request\"\n> \"Changing reasoning_effort mid-session takes effect on the next LLM call\"\n> Values: \"low\", \"medium\", \"high\", null\n\n**Files to create:**\n- packages/agent/src/steering.ts — steer(), follow_up(), drain_steering()\n- packages/agent/src/events.ts — SessionEvent, EventKind enum, EventEmitter (async iterator)\n- packages/agent/src/loop-detection.ts — detect_loop(), extract_tool_call_signatures()\n\n**Tests (packages/agent/tests/steering.test.ts):**\n- steer() queues message that appears after current tool round\n- steer() message appears as SteeringTurn in history\n- SteeringTurns converted to user-role messages for LLM\n- follow_up() queues message processed after current input completes\n- follow_up() triggers a new processing cycle\n- Multiple steering messages drained in order\n- Steering while idle: delivered on next submit()\n\n**Tests (packages/agent/tests/events.test.ts):**\n- SESSION_START emitted on session creation\n- SESSION_END emitted on session close\n- USER_INPUT emitted on submit\n- ASSISTANT_TEXT_END emitted after LLM response\n- TOOL_CALL_START emitted before tool execution (includes tool name, call ID)\n- TOOL_CALL_END emitted after execution with FULL untruncated output\n- STEERING_INJECTED emitted when steering message added\n- TURN_LIMIT emitted when limit hit\n- ERROR emitted on errors\n- Events delivered via async iterator\n- Events include timestamp and session_id\n\n**Tests (packages/agent/tests/loop-detection.test.ts):**\n- No loop detected when calls are varied\n- Pattern length 1: same call repeated N times → detected\n- Pattern length 2: A,B,A,B,A,B → detected\n- Pattern length 3: A,B,C,A,B,C,A,B,C → detected\n- Window too small (fewer than window_size calls) → no detection\n- Warning injected as SteeringTurn\n- enable_loop_detection=false disables detection\n- Custom loop_detection_window respected","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-11T00:59:04.239202Z","created_by":"jhugman","updated_at":"2026-02-11T00:59:04.239202Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-3er.6","depends_on_id":"df-3er","type":"parent-child","created_at":"2026-02-11T00:59:04.239202Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-3er.7","title":"Subagent spawning for parallel and scoped work","description":"Implement subagent spawning for parallel/scoped work.\n\n**Spec references (coding-agent-loop-spec.md):**\n\n§7.1 Concept:\n> \"A subagent is a child session spawned by the parent to handle a scoped task. The subagent runs its own agentic loop with its own conversation history but shares the parent's execution environment (same filesystem, same working directory or a subdirectory).\"\n\n§7.2 Spawn Interface — four tools:\n> spawn_agent: task (required), working_dir?, model?, max_turns? (default 50) → agent_id + initial status\n> send_input: agent_id, message → acknowledgement\n> wait: agent_id → SubAgentResult (output text, success boolean, turns used)\n> close_agent: agent_id → final status\n\n§7.3 SubAgent Lifecycle:\n> SubAgentHandle: id, session (independent), status (\"running\"/\"completed\"/\"failed\")\n> SubAgentResult: output (final text), success, turns_used\n> \"Gets its own Session with independent conversation history\"\n> \"Shares the parent's ExecutionEnvironment (same filesystem)\"\n> \"Uses the parent's ProviderProfile (or an overridden model)\"\n> \"Has its own turn limits (configurable, default: 50)\"\n> \"Cannot spawn sub-sub-agents (depth limiting, default max depth: 1, configurable via max_subagent_depth)\"\n\n§7.4 Use Cases:\n> Parallel exploration, focused refactoring, test execution, alternative approaches\n\n§2.2 SessionConfig:\n> \"max_subagent_depth: Integer = 1 — max nesting level for subagents\"\n\n**Files to create:**\n- packages/agent/src/subagent.ts — SubAgentHandle, SubAgentResult, subagent tool executors (spawn_agent, send_input, wait, close_agent)\n\n**Tests (packages/agent/tests/subagent.test.ts):**\n- spawn_agent creates a child session with independent history\n- spawn_agent: child shares parent's execution environment\n- spawn_agent: child uses parent's provider profile by default\n- spawn_agent: model override creates child with different model\n- spawn_agent: working_dir scopes child to subdirectory\n- spawn_agent: max_turns defaults to 50\n- send_input sends a message to running subagent\n- wait blocks until subagent completes and returns SubAgentResult\n- wait returns output text, success boolean, turns_used\n- close_agent terminates a running subagent\n- close_agent on already-completed agent returns final status\n- Depth limiting: max_subagent_depth=1 prevents sub-sub-agents\n- Depth limiting: max_subagent_depth=0 prevents any subagents\n- Subagent results returned to parent as tool results\n- Multiple concurrent subagents can run simultaneously","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-11T00:59:05.022976Z","created_by":"jhugman","updated_at":"2026-02-11T00:59:05.022976Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-3er.7","depends_on_id":"df-3er","type":"parent-child","created_at":"2026-02-11T00:59:05.022976Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-3j0","title":"Support general $variable expansion in prompts, settable from CLI","description":"Support general $variable expansion in prompts with declaration and validation.\n\n**Design:**\n1. Declare variables in the graph block: graph [vars=\"feature, priority\"]\n2. Provide optional defaults inline: graph [vars=\"feature, priority=high\"]\n3. VariableExpansionTransform expands any $identifier in prompt/label/goal attributes\n4. CLI passes values via --set key=value (repeatable), overriding defaults\n5. graph [goal=\"...\"] is sugar: goal is implicitly declared with its value as default\n\n**Validation (new rule):**\n- vars_declared: every $variable referenced in prompts must be declared in vars\n- vars_resolved: every declared variable without a default must have a value from --set (checked at runtime, not static validation)\n- Unknown $variables in prompts produce an error diagnostic\n\n**Backward compat:**\n- $goal continues to work as before (implicitly declared if graph[goal] is set)\n- Files without vars attribute skip variable declaration checks","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-10T23:13:34.774313Z","created_by":"jhugman","updated_at":"2026-02-10T23:22:21.933022Z","closed_at":"2026-02-10T23:22:21.932995Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0}
{"id":"df-3tv","title":"Epic 13: Stylesheet validation and shape selectors","description":"Implement missing stylesheet features per spec §7.2 and §8.3.\n\nTwo gaps: (1) the `stylesheet_syntax` validation rule that checks model_stylesheet parses correctly, and (2) shape-based selectors in the stylesheet grammar.\n\nSpec §7.2: \"`stylesheet_syntax` — ERROR — The `model_stylesheet` attribute must parse as valid stylesheet rules.\"\n\nSpec §8.3/§11.10: \"Selectors by shape name work (e.g., `box { model = \"claude-opus-4-6\" }`)\" with specificity order \"universal < shape < class < ID\".","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-11T00:32:45.046829Z","created_by":"jhugman","updated_at":"2026-02-11T01:19:42.847227Z","closed_at":"2026-02-11T01:19:42.847178Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"df-3tv.1","title":"Add stylesheet_syntax validation rule","description":"Spec §7.2: \"`stylesheet_syntax` — ERROR — The `model_stylesheet` attribute must parse as valid stylesheet rules.\"\n\nWhen a graph declares `model_stylesheet`, attempt to parse it via `parseStylesheet()`. If parsing throws, produce an ERROR diagnostic with rule name `stylesheet_syntax`.\n\n## Files\n- `packages/attractor-core/src/validation/index.ts` — add rule to BUILT_IN_RULES\n- `packages/attractor-core/tests/validation.test.ts` — add tests\n\n## Tests\n- valid stylesheet → no diagnostic\n- malformed stylesheet (missing colon) → ERROR diagnostic with rule=stylesheet_syntax\n- empty stylesheet → no diagnostic","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T00:32:57.002474Z","created_by":"jhugman","updated_at":"2026-02-11T01:19:42.791650Z","closed_at":"2026-02-11T01:19:42.791599Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-3tv.1","depends_on_id":"df-3tv","type":"parent-child","created_at":"2026-02-11T00:32:57.002474Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-3tv.2","title":"Add shape-based stylesheet selectors","description":"Spec §8.3: Selectors include shape names with specificity between universal and class.\n\nSpec §11.10: \"Selectors by shape name work (e.g., `box { model = \"claude-opus-4-6\" }`)\"\n\nSpecificity order per spec: universal (0) < shape (1) < class (2) < ID (3).\n\nCurrently `StyleSelector.type` supports `universal | class | id`. Add `shape` type with specificity 1, bump class to 2, ID to 3.\n\n## Files\n- `packages/attractor-core/src/stylesheet/index.ts` — parse bare identifiers as shape selectors, update specificity values\n- `packages/attractor-core/src/transforms/index.ts` — pass node.shape to `resolveStyleProperties()`\n- `packages/attractor-core/tests/stylesheet.test.ts` — add tests\n\n## Tests\n- `box { llm_model: claude-opus-4-6; }` matches nodes with shape=box\n- specificity: universal < shape < class < ID\n- explicit node attributes still override shape selector","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-11T00:32:57.029129Z","created_by":"jhugman","updated_at":"2026-02-11T01:19:42.821869Z","closed_at":"2026-02-11T01:19:42.821824Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-3tv.2","depends_on_id":"df-3tv","type":"parent-child","created_at":"2026-02-11T00:32:57.029129Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-3ug","title":"Add --goal CLI flag to override graph goal attribute","description":"The CLI has no way to set or override the $goal variable from the command line. Add a --goal <text> flag to the run command that overrides the graph-level goal attribute before variable expansion runs. This allows the same DOT file to be reused with different goals without editing it.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-10T23:09:52.727613Z","created_by":"jhugman","updated_at":"2026-02-10T23:13:40.557023Z","closed_at":"2026-02-10T23:13:40.557009Z","close_reason":"Superseded by df-3j0 (general variable support)","source_repo":".","compaction_level":0,"original_size":0}
{"id":"df-3ve","title":"Epic 6: Execution Engine","description":"Core execution loop, edge selection, retry logic, goal gate enforcement.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-10T19:03:14.991035Z","created_by":"jhugman","updated_at":"2026-02-10T19:16:09.237426Z","closed_at":"2026-02-10T19:16:09.237411Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"labels":["critical-path","engine"]}
{"id":"df-89v","title":"Epic 10: Event System and CLI","description":"PipelineEvent types, event emitter, CLI entry point.","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-10T19:03:15.060872Z","created_by":"jhugman","updated_at":"2026-02-10T19:16:09.298407Z","closed_at":"2026-02-10T19:16:09.298393Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"labels":["cli","events"]}
{"id":"df-aes","title":"Epic 17: Unified LLM Client — multi-provider abstraction layer","description":"Implement the Unified LLM Client per docs/specs/unified-llm-spec.md.\n\nA new package (@attractor/llm) that provides a single interface across multiple LLM providers (OpenAI Responses API, Anthropic Messages API, Gemini native API). The coding agent loop (Epic 18) depends on this.\n\nFour-layer architecture:\n- Layer 1: Provider Specification (ProviderAdapter interface, shared types)\n- Layer 2: Provider Utilities (HTTP client, SSE parsing, retry, normalization)\n- Layer 3: Core Client (routing, middleware, configuration)\n- Layer 4: High-Level API (generate(), stream(), generate_object())\n\nKey requirements:\n- Native API usage per provider (NOT compatibility layers)\n- Streaming-first design with start/delta/end event pattern\n- Prompt caching (automatic for OpenAI/Gemini, explicit cache_control injection for Anthropic)\n- Reasoning token tracking across all providers\n- Model catalog with capability metadata\n- Middleware/interceptor pattern for cross-cutting concerns\n- Comprehensive error hierarchy with retryability classification\n\nNew package: packages/llm/","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-11T00:52:45.002993Z","created_by":"jhugman","updated_at":"2026-02-11T00:52:45.002993Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"df-aes.1","title":"Package scaffolding and data model types","description":"Create the @attractor/llm package and implement all core data model types from spec §3.\n\n**Spec references (unified-llm-spec.md):**\n\n§3.1 Message:\n> \"The fundamental unit of conversation. A conversation is an ordered List<Message>.\"\n> Fields: role, content (List<ContentPart>), name, tool_call_id\n> Convenience constructors: Message.system(), Message.user(), Message.assistant(), Message.tool_result()\n> Text accessor: \"Returns the concatenation of all ContentPart entries where kind == TEXT.\"\n\n§3.2 Role:\n> \"Five roles cover the semantics of all major providers: SYSTEM, USER, ASSISTANT, TOOL, DEVELOPER\"\n\n§3.3–3.5 ContentPart (tagged union):\n> \"Each message contains a list of ContentPart objects. Using a list rather than a single string enables multimodal messages.\"\n> ContentKind enum: TEXT, IMAGE, AUDIO, DOCUMENT, TOOL_CALL, TOOL_RESULT, THINKING, REDACTED_THINKING\n> Data structures: ImageData, AudioData, DocumentData, ToolCallData, ToolResultData, ThinkingData\n\n§3.6 Request:\n> Fields: model, messages, provider, tools, tool_choice, response_format, temperature, top_p, max_tokens, stop_sequences, reasoning_effort, metadata, provider_options\n\n§3.7 Response:\n> Fields: id, model, provider, message, finish_reason, usage, raw, warnings, rate_limit\n> Convenience accessors: response.text, response.tool_calls, response.reasoning\n\n§3.8 FinishReason:\n> \"A dual representation preserving both portable semantics and provider-specific detail.\"\n> Values: stop, length, tool_calls, content_filter, error, other\n\n§3.9 Usage:\n> Fields: input_tokens, output_tokens, total_tokens, reasoning_tokens, cache_read_tokens, cache_write_tokens, raw\n> \"Usage objects must support addition for aggregating across multi-step operations\"\n\n§3.10 ResponseFormat, §3.11 Warning, §3.12 RateLimitInfo\n\n§3.13–3.14 StreamEvent and StreamEventType:\n> start/delta/end pattern for TEXT, REASONING, TOOL_CALL\n> Types: STREAM_START, TEXT_START/DELTA/END, REASONING_START/DELTA/END, TOOL_CALL_START/DELTA/END, FINISH, ERROR, PROVIDER_EVENT\n\n§5.1 Tool, §5.3 ToolChoice, §5.4 ToolCall/ToolResult\n\n**Files to create:**\n- packages/llm/package.json — new package in the monorepo\n- packages/llm/tsconfig.json\n- packages/llm/src/index.ts — public API barrel\n- packages/llm/src/types/message.ts — Message, Role\n- packages/llm/src/types/content.ts — ContentPart, ContentKind, ImageData, AudioData, DocumentData, ToolCallData, ToolResultData, ThinkingData\n- packages/llm/src/types/request.ts — Request, ResponseFormat\n- packages/llm/src/types/response.ts — Response, FinishReason, Usage, Warning, RateLimitInfo\n- packages/llm/src/types/stream.ts — StreamEvent, StreamEventType\n- packages/llm/src/types/tools.ts — Tool, ToolChoice, ToolCall, ToolResult\n- packages/llm/src/types/index.ts — barrel\n\n**Tests (packages/llm/tests/types.test.ts):**\n- Message convenience constructors produce correct role + content structure\n- Message.text accessor concatenates only TEXT content parts\n- Usage addition sums integer fields, handles None+Some as Some\n- FinishReason maps all provider raw values correctly\n- ContentPart tagged union enforces kind/data correspondence\n- StreamEvent covers all event types in the enum","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-11T00:53:09.174624Z","created_by":"jhugman","updated_at":"2026-02-11T00:53:09.174624Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-aes.1","depends_on_id":"df-aes","type":"parent-child","created_at":"2026-02-11T00:53:09.174624Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-aes.2","title":"Error hierarchy and retry utilities","description":"Implement the error taxonomy, retryability classification, and retry policy from spec §6.\n\n**Spec references (unified-llm-spec.md):**\n\n§6.1 Error Taxonomy:\n> \"All library errors inherit from a single base: SDKError { message, cause }\"\n> Hierarchy: SDKError → ProviderError (AuthenticationError, AccessDeniedError, NotFoundError, InvalidRequestError, RateLimitError, ServerError, ContentFilterError, ContextLengthError, QuotaExceededError), RequestTimeoutError, AbortError, NetworkError, StreamError, InvalidToolCallError, NoObjectGeneratedError, ConfigurationError\n\n§6.2 ProviderError fields:\n> \"provider, status_code, error_code, retryable, retry_after, raw\"\n\n§6.3 Retryability:\n> Non-retryable: 401 (auth), 403 (access), 404 (not found), 400/422 (invalid), 413 (context length), quota, content filter, config\n> Retryable: 429 (rate limit), 500-504 (server), timeout, network, stream\n> \"Unknown errors default to retryable. This is a deliberate conservative choice.\"\n\n§6.4 HTTP Status Code Mapping — table of status code → error type\n\n§6.5 Error Message Classification:\n> \"Messages containing 'not found' or 'does not exist' -> NotFoundError\"\n> \"Messages containing 'context length' or 'too many tokens' -> ContextLengthError\"\n\n§6.6 Retry Policy:\n> \"max_retries=2, base_delay=1.0, max_delay=60.0, backoff_multiplier=2.0, jitter=true, on_retry callback\"\n> Exponential backoff: delay = MIN(base_delay * (backoff_multiplier ^ n), max_delay); jitter +/- 50%\n> \"When Retry-After exceeds max_delay, do NOT retry. Raise the error immediately.\"\n> \"Retries apply to individual LLM calls, not to entire multi-step operations.\"\n> \"Low-level Client.complete() and Client.stream() never retry automatically.\"\n\n**Files to create:**\n- packages/llm/src/errors.ts — SDKError, full error hierarchy, error_from_status_code() helper\n- packages/llm/src/retry.ts — RetryPolicy, exponential backoff with jitter, retry() utility, Retry-After handling\n\n**Tests (packages/llm/tests/errors.test.ts):**\n- Each HTTP status code maps to the correct error type\n- Retryable flag is correct for each error type\n- Unknown status codes default to retryable\n- Error message classification (content containing \"not found\" → NotFoundError)\n- ProviderError preserves raw response body and error_code\n\n**Tests (packages/llm/tests/retry.test.ts):**\n- Exponential backoff delays increase correctly (1s, 2s, 4s, 8s, 16s)\n- Jitter applies +/- 50% variation\n- Delay is capped at max_delay\n- Retry-After header overrides backoff when within max_delay\n- Retry-After exceeding max_delay causes immediate raise (no retry)\n- max_retries=0 disables retries\n- on_retry callback fires before each retry with (error, attempt, delay)\n- Non-retryable errors are never retried\n- Retryable errors (429, 500) are retried up to max_retries","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-11T00:53:29.376505Z","created_by":"jhugman","updated_at":"2026-02-11T00:53:29.376505Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-aes.2","depends_on_id":"df-aes","type":"parent-child","created_at":"2026-02-11T00:53:29.376505Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-aes.3","title":"Provider adapter interface and SSE/HTTP utilities","description":"Implement the ProviderAdapter interface (Layer 1) and shared provider utilities (Layer 2).\n\n**Spec references (unified-llm-spec.md):**\n\n§2.4 Provider Adapter Interface:\n> \"Every provider must implement this interface:\n>   INTERFACE ProviderAdapter:\n>     PROPERTY name : String\n>     FUNCTION complete(request: Request) -> Response\n>     FUNCTION stream(request: Request) -> AsyncIterator<StreamEvent>\"\n> Optional: close(), initialize(), supports_tool_choice(mode)\n> \"Why two methods, not one. A single method with a stream: boolean flag was rejected because the return types are fundamentally different.\"\n\n§7.7 SSE Parsing:\n> \"A proper SSE parser must handle: event: lines (event type), data: lines (payload, may span multiple lines), retry: lines, comment lines (starting with :), blank lines (event boundary)\"\n> \"The parser yields (event_type, data) tuples.\"\n\n§4.7 Timeouts:\n> \"AdapterTimeout: connect (10s default), request (120s default), stream_read (30s default, max time between consecutive stream events)\"\n\n§2.7 Native API Usage:\n> \"Each provider adapter MUST use the provider's native, preferred API — not a compatibility layer.\"\n> OpenAI: Responses API (/v1/responses)\n> Anthropic: Messages API (/v1/messages)\n> Gemini: Gemini API (/v1beta/models/*/generateContent)\n\n**Files to create:**\n- packages/llm/src/provider/adapter.ts — ProviderAdapter interface, AdapterTimeout\n- packages/llm/src/provider/sse.ts — SSE parser (AsyncIterator<{event, data}>)\n- packages/llm/src/provider/http.ts — Shared HTTP client helper (fetch-based, timeout enforcement, header management)\n- packages/llm/src/provider/utils.ts — Response normalization, JSON schema translation helpers\n- packages/llm/src/provider/index.ts — barrel\n\n**Tests (packages/llm/tests/sse.test.ts):**\n- Parses standard SSE: event: + data: lines separated by blank lines\n- Handles multi-line data: fields (concatenated with newline)\n- Ignores comment lines (starting with :)\n- Handles retry: lines\n- Handles events with no event: field (default event type)\n- Handles stream termination (connection close)\n- Parses real Anthropic SSE sample (message_start, content_block_start, etc.)\n- Parses real OpenAI Responses API SSE sample (response.output_text.delta, etc.)\n\n**Tests (packages/llm/tests/http.test.ts):**\n- Connect timeout fires and raises RequestTimeoutError\n- Request timeout fires and raises RequestTimeoutError\n- Stream read timeout fires between events\n- Authorization headers set correctly per provider convention","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-11T00:53:49.600893Z","created_by":"jhugman","updated_at":"2026-02-11T00:53:49.600893Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-aes.3","depends_on_id":"df-aes","type":"parent-child","created_at":"2026-02-11T00:53:49.600893Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-aes.4","title":"Core Client — routing, middleware, configuration","description":"Implement the Core Client (Layer 3) with provider routing, middleware, and environment-based setup.\n\n**Spec references (unified-llm-spec.md):**\n\n§2.2 Client Configuration:\n> \"client = Client.from_env()\" — reads OPENAI_API_KEY, ANTHROPIC_API_KEY, GEMINI_API_KEY (GOOGLE_API_KEY fallback)\n> \"Only providers whose keys are present in the environment are registered. The first registered provider becomes the default.\"\n> Programmatic: Client with providers map and default_provider\n\n§2.2 Provider Resolution:\n> \"When a request specifies a provider field, the Client routes to that adapter. When the provider field is omitted, the Client uses default_provider. If no default is set and no provider is specified, the Client raises a configuration error. The Client never guesses.\"\n\n§2.3 Middleware / Interceptor Pattern:\n> \"Middleware wraps provider calls and can inspect or modify requests, inspect or modify responses, and perform side effects.\"\n> \"Execution order: registration order for request phase, reverse order for response phase.\"\n> \"Streaming middleware must also apply to streaming requests.\"\n\n§2.5 Module-Level Default Client:\n> \"High-level functions use a module-level default client. Lazily initialized from environment variables on first use.\"\n> \"set_default_client(my_client)\" / \"generate(…, client = my_client)\"\n\n§2.6 Concurrency Model:\n> \"All provider calls are non-blocking. The Client holds no mutable state between requests. Provider adapters manage their own connection pools.\"\n\n**Files to create:**\n- packages/llm/src/client.ts — Client class (from_env, register, route, middleware chain, close)\n- packages/llm/src/middleware.ts — Middleware type definition, compose utility\n- packages/llm/src/defaults.ts — Module-level default client, set_default_client(), get_default_client()\n\n**Tests (packages/llm/tests/client.test.ts):**\n- Client.from_env() registers adapters only for present API keys\n- Client.from_env() sets first registered provider as default\n- Provider routing dispatches to correct adapter by name\n- Omitted provider uses default_provider\n- Missing provider + no default raises ConfigurationError\n- Middleware executes in registration order (request) and reverse order (response)\n- Streaming middleware wraps event iterator\n- Multiple concurrent requests to same provider are safe (no shared mutable state)\n- Client.close() calls close() on all adapters","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-11T00:54:18.658798Z","created_by":"jhugman","updated_at":"2026-02-11T00:54:18.658798Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-aes.4","depends_on_id":"df-aes","type":"parent-child","created_at":"2026-02-11T00:54:18.658798Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-aes.5","title":"Anthropic adapter — Messages API, thinking blocks, prompt caching","description":"Implement the Anthropic provider adapter using the Messages API.\n\n**Spec references (unified-llm-spec.md):**\n\n§2.7 Native API Usage:\n> \"Anthropic: Messages API (/v1/messages). The Messages API supports extended thinking with thinking blocks and signatures, prompt caching with cache_control, beta feature headers, and the strict user/assistant alternation model.\"\n\n§7.3 Anthropic Message Translation:\n> SYSTEM → Extracted to system parameter (not in messages array)\n> DEVELOPER → Merged with system parameter\n> USER → \"user\" role\n> ASSISTANT → \"assistant\" role\n> TOOL → \"user\" role with tool_result content blocks\n> ContentPart translations for TEXT, IMAGE (url/base64), TOOL_CALL → tool_use, TOOL_RESULT → tool_result, THINKING, REDACTED_THINKING\n\n§7.3 Special behaviors:\n> \"Strict alternation: Anthropic requires alternating user/assistant messages. The adapter must merge consecutive same-role messages by combining their content arrays.\"\n> \"Tool results in user messages: Anthropic requires tool results to appear in user-role messages.\"\n> \"Thinking block round-tripping: Thinking and redacted_thinking blocks must be preserved exactly as received.\"\n> \"max_tokens is required: default to 4096 if not specified.\"\n\n§2.8 Beta Headers:\n> \"Anthropic uses the anthropic-beta header to enable features like: max-tokens-3-5-sonnet-2025-04-14, interleaved-thinking-2025-05-14, token-efficient-tools-2025-02-19, prompt-caching-2024-07-31\"\n> Pass via provider_options.anthropic.beta_headers\n\n§7.7 Anthropic Streaming:\n> message_start → metadata + input token count\n> content_block_start (type=text) → TEXT_START\n> content_block_delta (type=text) → TEXT_DELTA\n> content_block_stop (type=text) → TEXT_END\n> content_block_start (type=tool_use) → TOOL_CALL_START\n> content_block_delta (type=tool_use) → TOOL_CALL_DELTA\n> content_block_stop (type=tool_use) → TOOL_CALL_END\n> content_block_start (type=thinking) → REASONING_START\n> content_block_delta (type=thinking) → REASONING_DELTA\n> content_block_stop (type=thinking) → REASONING_END\n> message_stop → FINISH with accumulated response\n\n§5.3 ToolChoice (Anthropic-specific):\n> auto → type: auto\n> none → Omit tools from request entirely\n> required → type: any\n> named → type: tool, name: \"...\"\n\n§2.10 Prompt Caching:\n> \"Anthropic: Not automatic. Requires explicit cache_control annotations on content blocks.\"\n> \"The Anthropic adapter must inject cache_control breakpoints automatically for agentic workloads.\"\n> \"Without cache_control annotations, every turn re-processes the entire system prompt and conversation history at full price.\"\n\n§3.9 Usage mapping:\n> input_tokens → usage.input_tokens\n> output_tokens → usage.output_tokens\n> cache_read_tokens → usage.cache_read_input_tokens\n> cache_write_tokens → usage.cache_creation_input_tokens\n> Authentication: x-api-key header, anthropic-version header\n\n**Files to create:**\n- packages/llm/src/provider/anthropic.ts — AnthropicAdapter class\n\n**Tests (packages/llm/tests/anthropic.test.ts):**\n- Request translation: system message extracted to system parameter\n- Request translation: developer role merged with system\n- Request translation: strict alternation enforced (consecutive user messages merged)\n- Request translation: tool results wrapped in user role with tool_result blocks\n- Request translation: thinking blocks preserved with signatures\n- Request translation: redacted_thinking passed verbatim\n- Request translation: max_tokens defaults to 4096 when not specified\n- Request translation: beta headers joined as comma-separated anthropic-beta header\n- Request translation: image (url) → source type url; image (base64) → source type base64 with media_type\n- Response translation: text content blocks → TEXT ContentParts\n- Response translation: tool_use blocks → TOOL_CALL ContentParts with id, name, input\n- Response translation: thinking blocks → THINKING ContentParts with signature\n- Response translation: finish_reason mapping (end_turn→stop, stop_sequence→stop, max_tokens→length, tool_use→tool_calls)\n- Response translation: usage fields mapped correctly including cache tokens\n- Streaming: all event types translate to correct StreamEvent types\n- Streaming: accumulated response available at stream end\n- ToolChoice: none mode omits tools array from request body\n- Error translation: HTTP status codes mapped to correct error types\n- Prompt caching: cache_control breakpoints injected on system, tools, conversation prefix\n- Prompt caching: auto_cache=false via provider_options disables injection","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-11T00:56:15.016272Z","created_by":"jhugman","updated_at":"2026-02-11T00:56:15.016272Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-aes.5","depends_on_id":"df-aes","type":"parent-child","created_at":"2026-02-11T00:56:15.016272Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-aes.6","title":"OpenAI adapter — Responses API, reasoning tokens, compatible endpoints","description":"Implement the OpenAI provider adapter using the Responses API.\n\n**Spec references (unified-llm-spec.md):**\n\n§2.7 Native API Usage:\n> \"OpenAI: Responses API (/v1/responses). The Responses API properly surfaces reasoning tokens, supports built-in tools (web search, file search, code interpreter), and is OpenAI's forward-looking API. The Chat Completions API does not return reasoning tokens for reasoning models.\"\n\n§7.3 OpenAI Message Translation (Responses API):\n> SYSTEM → Extracted to instructions parameter\n> USER → input item type: message, role: user\n> ASSISTANT → input item type: message, role: assistant\n> TOOL → input item type: function_call_output, call_id, output\n> DEVELOPER → Extracted to instructions parameter (or developer role input item)\n> ContentPart translations: TEXT → input_text/output_text, IMAGE (url) → input_image with image_url, IMAGE (data) → data URI, TOOL_CALL → function_call input item, TOOL_RESULT → function_call_output\n\n§7.3 Special behaviors:\n> \"System messages are extracted to the instructions parameter, not included in the input array.\"\n> \"The reasoning.effort parameter controls reasoning for o-series models.\"\n> \"Tool calls and results are top-level input items, not nested within messages.\"\n\n§7.7 OpenAI Streaming (Responses API):\n> response.created → STREAM_START\n> response.output_text.delta → TEXT_DELTA (emit TEXT_START on first)\n> response.function_call_arguments.delta → TOOL_CALL_DELTA\n> output_item.done (text) → TEXT_END\n> output_item.done (function) → TOOL_CALL_END\n> response.completed → FINISH with usage (including reasoning_tokens)\n\n§3.8 FinishReason mapping:\n> stop → stop, length → length, tool_calls → tool_calls, content_filter → content_filter\n\n§3.9 Usage mapping:\n> input_tokens → usage.prompt_tokens\n> output_tokens → usage.completion_tokens\n> reasoning_tokens → usage.completion_tokens_details.reasoning_tokens\n> cache_read_tokens → usage.prompt_tokens_details.cached_tokens\n\n§3.9 Reasoning Token Handling:\n> \"The Responses API returns usage.output_tokens_details.reasoning_tokens\"\n> \"The reasoning_effort request parameter maps to reasoning.effort in the Responses API request body.\"\n> \"Reasoning content is not visible in the response for GPT-5.2 series models.\"\n\n§2.10 Prompt Caching:\n> \"OpenAI: Automatic — the Responses API caches shared prefixes server-side. SDK action: None.\"\n\n§5.3 ToolChoice mapping:\n> auto → \"auto\", none → \"none\", required → \"required\"\n> named → type: function, function: name: \"...\"\n\n§7.10 OpenAI-Compatible Endpoints:\n> \"Provide a separate OpenAICompatibleAdapter that uses the Chat Completions endpoint (/v1/chat/completions)\"\n> \"This adapter is distinct from the primary OpenAI adapter because third-party services typically only implement the Chat Completions protocol.\"\n\n**Files to create:**\n- packages/llm/src/provider/openai.ts — OpenAIAdapter class (Responses API)\n- packages/llm/src/provider/openai-compatible.ts — OpenAICompatibleAdapter class (Chat Completions)\n\n**Tests (packages/llm/tests/openai.test.ts):**\n- Request translation: system message extracted to instructions parameter\n- Request translation: user/assistant messages converted to input items\n- Request translation: tool results converted to function_call_output items\n- Request translation: reasoning_effort mapped to reasoning.effort in request body\n- Request translation: image (url) → input_image; image (data) → data URI\n- Response translation: output_text → TEXT ContentParts\n- Response translation: function_call → TOOL_CALL ContentParts with id, name, arguments\n- Response translation: finish_reason mapping (stop→stop, length→length, tool_calls→tool_calls)\n- Response translation: usage including reasoning_tokens and cache_read_tokens\n- Streaming: all Responses API event types translate correctly\n- Streaming: TEXT_START emitted on first text delta\n- ToolChoice: all modes translated correctly\n- Error translation: HTTP status codes mapped correctly\n\n**Tests (packages/llm/tests/openai-compatible.test.ts):**\n- Uses Chat Completions format (/v1/chat/completions)\n- Standard message array format (not input items)\n- Streaming: data: JSON lines with choices[].delta\n- Does not support reasoning tokens","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-11T00:56:15.753039Z","created_by":"jhugman","updated_at":"2026-02-11T00:56:15.753039Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-aes.6","depends_on_id":"df-aes","type":"parent-child","created_at":"2026-02-11T00:56:15.753039Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-aes.7","title":"Gemini adapter — native API, synthetic tool call IDs, streaming","description":"Implement the Gemini provider adapter using the native Gemini API.\n\n**Spec references (unified-llm-spec.md):**\n\n§2.7 Native API Usage:\n> \"Gemini: Gemini API (/v1beta/models/*/generateContent). The native Gemini API supports grounding with Google Search, code execution, system instructions, and cached content.\"\n\n§7.3 Gemini Message Translation:\n> SYSTEM → Extracted to systemInstruction field\n> DEVELOPER → Merged with systemInstruction\n> USER → \"user\" role\n> ASSISTANT → \"model\" role\n> TOOL → \"user\" role with functionResponse parts\n> ContentPart: TEXT → text field, IMAGE (url) → fileData with fileUri, IMAGE (data) → inlineData with base64, TOOL_CALL → functionCall, TOOL_RESULT → functionResponse\n\n§7.3 Special behaviors:\n> \"No developer role: Treated the same as system.\"\n> \"Tool call IDs: Gemini does not assign unique IDs to function calls. The adapter must generate synthetic unique IDs and maintain a mapping from synthetic IDs to function names.\"\n> \"Function response format: Gemini's functionResponse uses the function name (not the call ID) and expects a dict.\"\n> \"Streaming format: Gemini uses JSON chunks (optionally via SSE with ?alt=sse).\"\n\n§7.7 Gemini Streaming:\n> \"data: candidates[].content.parts[].text → TEXT_DELTA (emit TEXT_START on first)\"\n> \"parts[].functionCall → TOOL_CALL_START + TOOL_CALL_END (full call in one chunk)\"\n> \"candidate.finishReason → TEXT_END\"\n> \"Final chunk → FINISH with accumulated response\"\n> \"Gemini typically delivers function calls as complete objects in a single chunk, not incrementally.\"\n\n§3.8 FinishReason mapping:\n> STOP → stop, MAX_TOKENS → length, SAFETY → content_filter, RECITATION → content_filter\n> \"(has tool calls) → tool_calls — Gemini does not have a dedicated tool_calls finish reason.\"\n\n§3.9 Usage mapping:\n> input_tokens → usageMetadata.promptTokenCount\n> output_tokens → usageMetadata.candidatesTokenCount\n> reasoning_tokens → usageMetadata.thoughtsTokenCount\n> cache_read_tokens → usageMetadata.cachedContentTokenCount\n\n§5.3 ToolChoice mapping:\n> auto → \"AUTO\", none → \"NONE\", required → \"ANY\"\n> named → mode: ANY, allowedFunctionNames: [\"...\"]\n\n§7.4 Tool Definition Translation:\n> Wrapper structure: functionDeclarations array\n\nAuthentication: key query parameter, API versioning via URL path (/v1beta/)\n\n**Files to create:**\n- packages/llm/src/provider/gemini.ts — GeminiAdapter class\n\n**Tests (packages/llm/tests/gemini.test.ts):**\n- Request translation: system message extracted to systemInstruction\n- Request translation: developer role merged with systemInstruction\n- Request translation: user → user role, assistant → model role\n- Request translation: tool results use function name (not call ID) in functionResponse\n- Request translation: tool results wrapped in user role\n- Request translation: image (url) → fileData, image (data) → inlineData\n- Response translation: text parts → TEXT ContentParts\n- Response translation: functionCall parts → TOOL_CALL ContentParts with synthetic IDs\n- Response translation: synthetic IDs maintained for round-tripping tool results\n- Response translation: finish reason mapping (STOP→stop, MAX_TOKENS→length, SAFETY→content_filter)\n- Response translation: presence of functionCall parts infers tool_calls finish reason\n- Response translation: usage mapped from usageMetadata fields\n- Response translation: thoughtsTokenCount → reasoning_tokens\n- Streaming: text delta chunks translate to TEXT_DELTA events\n- Streaming: functionCall chunks emit both START and END events\n- ToolChoice: all modes translated correctly\n- Tool definitions wrapped in functionDeclarations array\n- Error translation: gRPC status codes mapped (NOT_FOUND→NotFoundError, RESOURCE_EXHAUSTED→RateLimitError, etc.)\n- Authentication: API key passed as query parameter","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-11T00:56:16.921689Z","created_by":"jhugman","updated_at":"2026-02-11T00:56:16.921689Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-aes.7","depends_on_id":"df-aes","type":"parent-child","created_at":"2026-02-11T00:56:16.921689Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-aes.8","title":"High-level API — generate(), stream(), generate_object(), tool loops","description":"Implement the high-level API (Layer 4): generate(), stream(), generate_object(), stream_object().\n\n**Spec references (unified-llm-spec.md):**\n\n§4.3 generate():\n> \"The primary blocking generation function. Wraps Client.complete() with tool execution loops, multi-step orchestration, prompt standardization, and automatic retries.\"\n> Parameters: model, prompt, messages, system, tools, tool_choice, max_tool_rounds (default 1), stop_when, response_format, temperature, top_p, max_tokens, stop_sequences, reasoning_effort, provider, provider_options, max_retries (default 2), timeout, abort_signal, client\n> \"Either prompt (a simple string) or messages (full conversation) is provided, not both. Using both is an error.\"\n> Returns GenerateResult with text, reasoning, tool_calls, tool_results, finish_reason, usage, total_usage, steps, response, output\n\n§4.4 stream():\n> \"Equivalent to generate() but yields events incrementally.\"\n> Returns StreamResult with async iteration, response(), text_stream, partial_response\n> \"When tools with execute handlers are provided and the model makes tool calls, the stream pauses while tools execute, emits a step_finish event, then resumes.\"\n\n§4.5 generate_object():\n> \"Structured output generation with schema validation.\"\n> Provider strategies: OpenAI native json_schema, Gemini native responseSchema, Anthropic fallback (prompt engineering or tool extraction)\n> \"If parsing or validation fails, the function raises NoObjectGeneratedError.\"\n\n§4.6 stream_object():\n> \"Streaming structured output with partial object updates.\"\n> \"Uses incremental JSON parsing to yield partial objects as tokens arrive.\"\n\n§4.7 Cancellation and Timeouts:\n> AbortController/AbortSignal pattern\n> TimeoutConfig: total timeout and per_step timeout\n\n§5.5 Active Tools vs Passive Tools:\n> \"Active tools have an execute handler. When used with generate(), the library automatically executes them and loops.\"\n> \"Passive tools have no execute handler. Tool calls are returned to the caller.\"\n\n§5.6 Multi-Step Tool Loop:\n> Loop: complete → check tool_calls → execute all → append results → repeat\n> Respects max_tool_rounds, stop_when condition\n> \"max_tool_rounds value of 0 means no automatic tool execution.\"\n\n§5.7 Parallel Tool Execution:\n> \"Execute all tool calls concurrently. Wait for ALL results before continuing. Send all results in a single continuation request. Preserve ordering. Handle partial failures gracefully.\"\n\n§4.4 StreamAccumulator:\n> \"A utility that collects stream events into a complete Response.\"\n\n**Files to create:**\n- packages/llm/src/api/generate.ts — generate() function, GenerateResult, StepResult\n- packages/llm/src/api/stream.ts — stream() function, StreamResult, StreamAccumulator\n- packages/llm/src/api/generate-object.ts — generate_object(), stream_object()\n- packages/llm/src/api/tool-loop.ts — Multi-step tool execution loop, parallel tool execution\n- packages/llm/src/api/index.ts — barrel\n\n**Tests (packages/llm/tests/generate.test.ts):**\n- generate() with simple prompt returns text\n- generate() with messages list works\n- generate() rejects when both prompt and messages provided\n- generate() with active tools executes them automatically\n- generate() max_tool_rounds=0 disables auto execution\n- generate() max_tool_rounds=1 allows one tool round then stops\n- generate() stop_when custom condition halts loop\n- generate() total_usage aggregates across all steps\n- generate() steps array tracks each round\n- generate() with abort_signal raises AbortError when signaled\n- generate() retries transient errors up to max_retries\n- generate() max_retries=0 disables retries\n\n**Tests (packages/llm/tests/stream.test.ts):**\n- stream() yields TEXT_DELTA events\n- stream() text_stream yields only text deltas\n- stream() response() returns accumulated Response after stream ends\n- stream() with tools: pauses during tool execution, emits step_finish, resumes\n- StreamAccumulator produces equivalent Response to complete()\n\n**Tests (packages/llm/tests/generate-object.test.ts):**\n- generate_object() returns parsed and validated output\n- generate_object() raises NoObjectGeneratedError on parse failure\n- generate_object() uses native json_schema for OpenAI/Gemini\n\n**Tests (packages/llm/tests/tool-loop.test.ts):**\n- Parallel tool calls: N calls executed concurrently\n- Parallel tool calls: all N results sent in single continuation\n- Parallel tool calls: results ordered to match call order\n- Partial failures: some tools fail, error results sent alongside successes\n- Unknown tool calls produce error results (not exceptions)","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-11T00:56:17.684873Z","created_by":"jhugman","updated_at":"2026-02-11T00:56:17.684873Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-aes.8","depends_on_id":"df-aes","type":"parent-child","created_at":"2026-02-11T00:56:17.684873Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-aes.9","title":"Model catalog — ModelInfo, lookup functions, JSON data file","description":"Implement the model catalog with capability metadata and lookup functions.\n\n**Spec references (unified-llm-spec.md):**\n\n§2.9 Model Catalog:\n> \"The SDK should ship with a catalog of known models to help consumers (especially AI coding agents) select valid model identifiers without guessing or hallucinating model names. The catalog is advisory, not restrictive — unknown model strings are still passed through to the provider.\"\n\nModelInfo record:\n> \"id, provider, display_name, context_window, max_output, supports_tools, supports_vision, supports_reasoning, input_cost_per_million, output_cost_per_million, aliases\"\n\nCurrent models (Feb 2026):\n> Anthropic: Claude Opus 4.6 (claude-opus-4-6), Claude Sonnet 4.5 (claude-sonnet-4-5)\n> OpenAI: GPT-5.2, GPT-5.2-mini, GPT-5.2-codex\n> Gemini: Gemini 3 Pro Preview, Gemini 3 Flash Preview\n\nLookup functions:\n> \"get_model_info(model_id) -> ModelInfo | None\"\n> \"list_models(provider?) -> List<ModelInfo>\"\n> \"get_latest_model(provider, capability?) -> ModelInfo | None — Returns the newest/best model for a provider, optionally filtered by capability (e.g., 'reasoning', 'vision', 'tools').\"\n\n> \"The catalog should be shipped as a data file (JSON or similar) that can be updated independently of the library code.\"\n> \"When in doubt, prefer the latest models.\"\n\n**Files to create:**\n- packages/llm/src/catalog/models.json — Model data (JSON, independently updatable)\n- packages/llm/src/catalog/index.ts — ModelInfo type, get_model_info(), list_models(), get_latest_model()\n\n**Tests (packages/llm/tests/catalog.test.ts):**\n- get_model_info(\"claude-opus-4-6\") returns correct ModelInfo with all fields\n- get_model_info(\"nonexistent\") returns null\n- list_models() returns all models\n- list_models(\"anthropic\") filters to Anthropic models only\n- get_latest_model(\"anthropic\") returns Claude Opus 4.6\n- get_latest_model(\"openai\") returns GPT-5.2\n- get_latest_model(\"gemini\") returns Gemini 3 Pro Preview\n- get_latest_model(\"anthropic\", \"reasoning\") returns a model with supports_reasoning=true\n- Aliases: get_model_info(\"sonnet\") resolves via aliases\n- Unknown model strings are not rejected (catalog is advisory)\n- All models in catalog have valid required fields (id, provider, display_name, context_window)","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-11T00:56:18.758234Z","created_by":"jhugman","updated_at":"2026-02-11T00:56:18.758234Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-aes.9","depends_on_id":"df-aes","type":"parent-child","created_at":"2026-02-11T00:56:18.758234Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-ako","title":"Update spec 10.7 to reflect implemented extended condition operators","description":"Spec 10.7 lists OR (||), NOT (!), contains, matches, and numeric comparisons (<, >, <=, >=) as future extensions. All of these are already implemented and tested (conditions.test.ts has 40+ tests covering them).\n\nThe spec should be updated to promote these from future to current, moving them into sections 10.2-10.5.\n\n## Files\n- docs/specs/attractor-spec.md -- move extended operators from 10.7 into 10.2 grammar, 10.3 semantics, 10.5 evaluation","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-11T00:35:06.533452Z","created_by":"jhugman","updated_at":"2026-02-11T00:35:06.533452Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"df-aqr","title":"Epic 16: Server mode — missing endpoints and URL path alignment","description":"Spec 9.5 defines several HTTP endpoints not yet implemented, and the existing endpoints use different URL paths than specified.\n\nCurrent paths: POST /run, GET /status/:id, POST /answer/:id, GET /events/:id\nSpec paths: POST /pipelines, GET /pipelines/{id}, POST /pipelines/{id}/questions/{qid}/answer, GET /pipelines/{id}/events\n\nMissing endpoints:\n- POST /pipelines/{id}/cancel -- Cancel a running pipeline\n- GET /pipelines/{id}/graph -- Get rendered graph visualization (SVG)\n- GET /pipelines/{id}/checkpoint -- Get current checkpoint state\n- GET /pipelines/{id}/context -- Get current context key-value store","status":"closed","priority":3,"issue_type":"epic","created_at":"2026-02-11T00:34:42.202460Z","created_by":"jhugman","updated_at":"2026-02-11T01:37:35.760669Z","closed_at":"2026-02-11T01:37:35.760620Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"df-aqr.1","title":"Align server URL paths with spec","description":"Spec 9.5 endpoint table:\n- POST /pipelines (currently POST /run)\n- GET /pipelines/{id} (currently GET /status/:runId)\n- GET /pipelines/{id}/events (currently GET /events/:runId)\n- POST /pipelines/{id}/questions/{qid}/answer (currently POST /answer/:runId)\n\nRename endpoints to match spec. This is a breaking change to the server API.\n\n## Files\n- packages/attractor-core/src/server/index.ts -- update route matching\n- packages/attractor-core/tests/server.test.ts -- update all endpoint URLs\n\n## Tests\n- existing server tests pass with new URLs\n- old URLs return 404","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-11T00:34:57.419682Z","created_by":"jhugman","updated_at":"2026-02-11T01:37:35.668603Z","closed_at":"2026-02-11T01:37:35.668547Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-aqr.1","depends_on_id":"df-aqr","type":"parent-child","created_at":"2026-02-11T00:34:57.419682Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-aqr.2","title":"Implement POST /pipelines/{id}/cancel endpoint","description":"Spec 9.5: POST /pipelines/{id}/cancel -- Cancel a running pipeline.\n\nNeeds a cancellation mechanism in PipelineRunner (e.g. an AbortController or cancelled flag checked in the main loop).\n\n## Files\n- packages/attractor-core/src/engine/runner.ts -- add cancel() method or accept AbortSignal\n- packages/attractor-core/src/server/index.ts -- add cancel endpoint, call runner.cancel()\n- packages/attractor-core/tests/server.test.ts -- add test\n\n## Tests\n- POST /pipelines/{id}/cancel on running pipeline -> 200, status becomes failed\n- POST /pipelines/{id}/cancel on completed pipeline -> 409 conflict","status":"closed","priority":3,"issue_type":"feature","created_at":"2026-02-11T00:34:57.446751Z","created_by":"jhugman","updated_at":"2026-02-11T01:37:35.692298Z","closed_at":"2026-02-11T01:37:35.692246Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-aqr.2","depends_on_id":"df-aqr","type":"parent-child","created_at":"2026-02-11T00:34:57.446751Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-aqr.3","title":"Implement GET /pipelines/{id}/checkpoint and /context endpoints","description":"Spec 9.5:\n- GET /pipelines/{id}/checkpoint -- Get current checkpoint state\n- GET /pipelines/{id}/context -- Get current context key-value store\n\n## Files\n- packages/attractor-core/src/server/index.ts -- add endpoints reading from RunState\n- packages/attractor-core/tests/server.test.ts -- add tests\n\n## Tests\n- GET /pipelines/{id}/checkpoint returns checkpoint JSON for running pipeline\n- GET /pipelines/{id}/context returns context snapshot\n- both return 404 for unknown runId","status":"closed","priority":4,"issue_type":"feature","created_at":"2026-02-11T00:34:57.467170Z","created_by":"jhugman","updated_at":"2026-02-11T01:37:35.715332Z","closed_at":"2026-02-11T01:37:35.715286Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-aqr.3","depends_on_id":"df-aqr","type":"parent-child","created_at":"2026-02-11T00:34:57.467170Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-aqr.4","title":"Implement GET /pipelines/{id}/graph SVG endpoint","description":"Spec 9.5: GET /pipelines/{id}/graph -- Get rendered graph visualization (SVG).\n\nRequires either shelling out to the dot command or using a JS DOT-to-SVG library. This is the lowest priority server endpoint since it requires external tooling.\n\n## Files\n- packages/attractor-core/src/server/index.ts -- add endpoint\n- packages/attractor-core/tests/server.test.ts -- add test\n\n## Tests\n- GET /pipelines/{id}/graph returns SVG content-type\n- GET /pipelines/{id}/graph returns 404 for unknown runId","status":"closed","priority":4,"issue_type":"feature","created_at":"2026-02-11T00:34:57.486512Z","created_by":"jhugman","updated_at":"2026-02-11T01:37:35.738838Z","closed_at":"2026-02-11T01:37:35.738788Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-aqr.4","depends_on_id":"df-aqr","type":"parent-child","created_at":"2026-02-11T00:34:57.486512Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-e6v","title":"Add missing validation rule tests","description":"Several validation rules are implemented but lack direct test coverage. The rules work (they are exercised indirectly by integration tests), but dedicated unit tests would catch regressions.\n\nMissing direct tests for:\n- edge_target_exists -- edge referencing nonexistent node -> ERROR\n- fidelity_valid -- invalid fidelity mode -> WARNING\n- retry_target_exists -- retry_target referencing nonexistent node -> WARNING\n- condition_syntax -- edge with malformed condition -> ERROR\n\n## Files\n- packages/attractor-core/tests/validation.test.ts -- add one test per rule above\n\n## Tests\n- edge from=A to=nonexistent -> ERROR rule=edge_target_exists\n- node with fidelity=bogus -> WARNING rule=fidelity_valid\n- node with retry_target=nonexistent -> WARNING rule=retry_target_exists\n- edge with condition containing invalid syntax -> ERROR rule=condition_syntax","status":"open","priority":4,"issue_type":"task","created_at":"2026-02-11T00:35:15.564392Z","created_by":"jhugman","updated_at":"2026-02-11T00:35:15.564392Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"df-g39","title":"Epic 11: Spec Completion — Remaining Gaps","description":"Track all remaining unimplemented or partially implemented features from the attractor-spec. These are the last ~4% of spec coverage needed for full compliance.","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-10T20:42:55.226667Z","created_by":"jhugman","updated_at":"2026-02-10T21:15:09.343034Z","closed_at":"2026-02-10T21:15:09.342994Z","close_reason":"All children completed","source_repo":".","compaction_level":0,"original_size":0}
{"id":"df-g39.1","title":"Implement Manager Loop Handler observe/steer cycles","description":"The ManagerLoopHandler in src/handlers/handlers.ts is a simplified stub that just marks success. Per spec §4.11, it should implement the full observation/steering loop: repeatedly observe subgraph state, decide whether to steer (inject guidance), continue, or terminate, up to max_cycles. Currently it logs max_cycles but does nothing with it.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-10T20:43:03.918219Z","created_by":"jhugman","updated_at":"2026-02-10T20:56:48.212257Z","closed_at":"2026-02-10T20:56:48.212226Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-g39.1","depends_on_id":"df-g39","type":"parent-child","created_at":"2026-02-10T20:43:03.918219Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-g39.2","title":"Wire parallel handler subgraph execution to runner","description":"The ParallelHandler has the setSubgraphExecutor() callback pattern and supports join policies (wait_all, first_success) and context isolation, but the actual subgraph execution is not wired through to the PipelineRunner. Each parallel branch should spawn a sub-execution of the identified subgraph. Per spec §4.8.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-10T20:43:07.150876Z","created_by":"jhugman","updated_at":"2026-02-10T21:00:59.270914Z","closed_at":"2026-02-10T21:00:59.270887Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-g39.2","depends_on_id":"df-g39","type":"parent-child","created_at":"2026-02-10T20:43:07.150876Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-g39.3","title":"Implement context fidelity at runtime","description":"Fidelity modes (full, truncate, compact, summary:low/medium/high) are defined in VALID_FIDELITY_MODES and validated, but not applied at runtime when building LLM context. Per spec §5.4, the fidelity mode should control how much prior context is passed to the LLM backend — truncating, compacting, or summarizing as appropriate.","status":"closed","priority":3,"issue_type":"feature","created_at":"2026-02-10T20:43:10.998883Z","created_by":"jhugman","updated_at":"2026-02-10T21:10:15.364676Z","closed_at":"2026-02-10T21:10:15.364652Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-g39.3","depends_on_id":"df-g39","type":"parent-child","created_at":"2026-02-10T20:43:10.998883Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-g39.4","title":"Implement checkpoint resume","description":"Checkpoint save/load structures exist in src/state/checkpoint.ts, but resuming a pipeline from a checkpoint is not integrated into the runner. Per spec §5.3, calling PipelineRunner.run() with a checkpoint file should restore state (current_node, completed_nodes, node_retries, context) and continue execution from where it left off.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-10T20:43:12.701453Z","created_by":"jhugman","updated_at":"2026-02-10T20:52:37.541373Z","closed_at":"2026-02-10T20:52:37.541343Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-g39.4","depends_on_id":"df-g39","type":"parent-child","created_at":"2026-02-10T20:43:12.701453Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-g39.5","title":"Add HTTP server mode","description":"Per spec §9.5, implement REST endpoints for web-based pipeline management: POST /run to start a pipeline, GET /status/:id for run status, POST /answer/:id to submit human-in-the-loop answers, and GET /events/:id for SSE event streaming. This is an optional deployment mode, not required for CLI usage.","status":"closed","priority":4,"issue_type":"feature","created_at":"2026-02-10T20:43:15.401940Z","created_by":"jhugman","updated_at":"2026-02-10T21:14:59.287138Z","closed_at":"2026-02-10T21:14:59.287110Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-g39.5","depends_on_id":"df-g39","type":"parent-child","created_at":"2026-02-10T20:43:15.401940Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-g39.6","title":"Implement tool call hooks (pre/post)","description":"Per spec §9.7, support pre_hook and post_hook attributes on tool nodes. These are shell commands that run before and after the tool_command, allowing setup/teardown, environment preparation, or result post-processing. Not currently implemented in the ToolHandler.","status":"closed","priority":3,"issue_type":"feature","created_at":"2026-02-10T20:43:18.680548Z","created_by":"jhugman","updated_at":"2026-02-10T21:07:23.124541Z","closed_at":"2026-02-10T21:07:23.124518Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-g39.6","depends_on_id":"df-g39","type":"parent-child","created_at":"2026-02-10T20:43:18.680548Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-g39.7","title":"Extend condition expression language","description":"Per spec §10.7, the condition language currently supports only = (equals), \\!= (not equals), and && (AND). Future operators to add: contains (substring match), matches (regex), OR (||), NOT (\\!), and numeric comparison (<, >, <=, >=). The spec marks these as future work but they're needed for full compliance.","status":"closed","priority":3,"issue_type":"feature","created_at":"2026-02-10T20:43:20.656100Z","created_by":"jhugman","updated_at":"2026-02-10T21:04:15.072648Z","closed_at":"2026-02-10T21:04:15.072618Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-g39.7","depends_on_id":"df-g39","type":"parent-child","created_at":"2026-02-10T20:43:20.656100Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-g39.8","title":"Wire loop_restart edge attribute to execution","description":"The loop_restart edge attribute is defined in the parser and model but not acted on during execution. Per the spec, when an edge with loop_restart=true is taken, the runner should reset retry counters and re-enter the target node as if starting a fresh loop iteration rather than a normal transition.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-10T20:43:23.746792Z","created_by":"jhugman","updated_at":"2026-02-10T20:49:29.156365Z","closed_at":"2026-02-10T20:49:29.156344Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"df-g39.8","depends_on_id":"df-g39","type":"parent-child","created_at":"2026-02-10T20:43:23.746792Z","created_by":"jhugman","metadata":"{}","thread_id":""}]}
{"id":"df-qrj","title":"Epic 8: Transforms and Model Stylesheet","description":"Variable expansion, stylesheet parser, stylesheet application, preparePipeline().","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-10T19:03:15.027382Z","created_by":"jhugman","updated_at":"2026-02-10T19:16:09.279677Z","closed_at":"2026-02-10T19:16:09.279662Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"labels":["stylesheet","transforms"]}
